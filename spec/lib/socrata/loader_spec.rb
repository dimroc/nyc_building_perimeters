require 'spec_helper'

describe Socrata::Loader do
  def sample_json
    <<-JSON
    {
      "meta" : {
        "view" : {
          "id" : "zsjh-u7ve",
          "name" : "Zip Codes Map",
          "columns" : [ {
            "id" : -1,
            "name" : "id",
            "dataTypeName" : "meta_data",
            "fieldName" : ":id",
            "position" : 0,
            "renderTypeName" : "meta_data"
          }, {
            "id" : 3362018,
            "name" : "Shape",
            "dataTypeName" : "geospatial",
            "description" : "Shape",
            "fieldName" : "shape",
            "position" : 2,
            "renderTypeName" : "geospatial",
            "tableColumnId" : 1560360,
            "width" : 100,
            "format" : {
            },
            "subColumnTypes" : [ "human_address", "latitude", "longitude", "machine_address", "needs_recoding", "geometry" ]
          }, {
            "id" : 3362019,
            "name" : "ZIP",
            "dataTypeName" : "text",
            "description" : "ZIP",
            "fieldName" : "zip",
            "position" : 3,
            "renderTypeName" : "text",
            "tableColumnId" : 1560361,
            "width" : 100
          } ]
        }
      },
      "data" : [ [ 1, [ null, "40.74916512200008", "-73.86942583199993", null, false, {
        "rings" : [ [ [ -73.86942583199993, 40.74916512200008 ], [ -73.86955990199993, 40.74914555000004 ], [ -73.87021396699993, 40.74908723300007 ], [ -73.8703564729999, 40.74907447700008 ], [ -73.87040365999991, 40.74907022500008 ], [ -73.87052257199991, 40.74905959400007 ], [ -73.87097571099991, 40.74901312900005 ], [ -73.8713583999999, 40.74896508300009 ], [ -73.87184221199993, 40.748913842000036 ], [ -73.87237382099994, 40.74885982400008 ], [ -73.8727748309999, 40.74882122900004 ], [ -73.8733043549999, 40.74876640100007 ], [ -73.87370224099993, 40.748725593000074 ], [ -73.87398419099992, 40.74869394400008 ], [ -73.87463071399992, 40.74862220400007 ], [ -73.87542336899992, 40.748535761000085 ], [ -73.87555805099993, 40.748522397000045 ], [ -73.87610964699991, 40.74846211000005 ], [ -73.87625295299995, 40.74844664200003 ], [ -73.87648078599995, 40.748424672000056 ], [ -73.8769258399999, 40.74837725600008 ], [ -73.8774173779999, 40.74832764200005 ], [ -73.87835139899994, 40.74823057200007 ], [ -73.87845535799994, 40.748219008000035 ], [ -73.87927904799994, 40.74813236400007 ], [ -73.87984020199991, 40.74806999800006 ], [ -73.88000021199991, 40.748054548000084 ], [ -73.88011938699992, 40.748042319000035 ], [ -73.88020773999995, 40.748033252000084 ], [ -73.8803128799999, 40.74802222000005 ], [ -73.88103618699995, 40.747946323000065 ], [ -73.88113873099991, 40.747935562000066 ], [ -73.88125193399992, 40.74792375800007 ], [ -73.88197241499995, 40.747848625000074 ], [ -73.8820723799999, 40.747838201000036 ], [ -73.88218607999994, 40.74782630000004 ], [ -73.88246241099995, 40.74779737700004 ], [ -73.88257002599994, 40.747786113000075 ], [ -73.88267312199991, 40.74777571000004 ], [ -73.88291471499991, 40.74775132900004 ], [ -73.8830004379999, 40.747742678000066 ], [ -73.88310622199992, 40.747730914000044 ], [ -73.88385381099994, 40.74764777300004 ], [ -73.88393704899994, 40.74763851600005 ], [ -73.88403464599992, 40.74762838800007 ], [ -73.88474369999994, 40.74755480600004 ], [ -73.88485663999995, 40.747543085000075 ], [ -73.88495637199992, 40.74753291400009 ], [ -73.88569503299993, 40.74745757900007 ], [ -73.88578866199992, 40.747448030000044 ], [ -73.88588197099995, 40.74743816000006 ], [ -73.88661202299994, 40.74736093100006 ], [ -73.88671782099993, 40.74734973900007 ], [ -73.88680843299994, 40.747340327000074 ], [ -73.88755405599994, 40.74726287000004 ], [ -73.88764753899994, 40.747253158000035 ], [ -73.88769960099995, 40.74724710400005 ], [ -73.88778451499991, 40.74723722900006 ], [ -73.88787705099992, 40.747227432000045 ], [ -73.88858298499991, 40.74715270200005 ], [ -73.8886789199999, 40.74714254600008 ], [ -73.88876946699992, 40.74713281000004 ], [ -73.88902443599994, 40.74710539200004 ], [ -73.88957253399991, 40.74704732500004 ], [ -73.8905025549999, 40.74695021500008 ], [ -73.89064206899991, 40.746935618000066 ], [ -73.89143256599993, 40.746852911000076 ], [ -73.8915726859999, 40.74683838100009 ], [ -73.89175171699992, 40.74681981500004 ], [ -73.89220658799991, 40.74677293000008 ], [ -73.89232216499994, 40.74676101600005 ], [ -73.89253751299992, 40.746738538000045 ], [ -73.89291555799991, 40.74669907800006 ], [ -73.89358944299994, 40.74662873300008 ], [ -73.89369593299995, 40.74661764600006 ], [ -73.89436939299992, 40.746547529000054 ], [ -73.89461078599993, 40.746522396000046 ], [ -73.89471788199995, 40.74651124400009 ], [ -73.89480946799995, 40.74650170800004 ], [ -73.8948658729999, 40.74649571100008 ], [ -73.89488500099992, 40.746493678000036 ], [ -73.89494086999991, 40.74648773700005 ], [ -73.89499422999995, 40.74648206400008 ], [ -73.89502066599994, 40.746479253000075 ], [ -73.89507269899991, 40.746473721000086 ], [ -73.89510375299994, 40.74653016700006 ], [ -73.89513106899994, 40.74657981100006 ], [ -73.89528392799991, 40.74685763700006 ], [ -73.8953284179999, 40.74693849500005 ], [ -73.89554730999993, 40.74742132300008 ], [ -73.89556469899992, 40.74745967900009 ], [ -73.89566101199995, 40.74764901600008 ], [ -73.89583618699993, 40.74795420000004 ], [ -73.89609895599995, 40.74837296700008 ], [ -73.89612750999993, 40.748419037000076 ], [ -73.8961512599999, 40.748457356000074 ], [ -73.89618864599993, 40.74851767600006 ], [ -73.89613428899992, 40.74852352800008 ], [ -73.8961118599999, 40.74852594300006 ], [ -73.89605839599994, 40.74853170000006 ], [ -73.89600218099991, 40.74853775200006 ], [ -73.89596899299994, 40.748541325000076 ], [ -73.89584080899994, 40.74855512600004 ], [ -73.89525369499995, 40.74831486000005 ], [ -73.89529403899991, 40.74843145700004 ], [ -73.89531997799992, 40.748506424000084 ], [ -73.89535262299995, 40.74860076900006 ], [ -73.89550225999994, 40.748840761000054 ], [ -73.89587599299995, 40.74944015500006 ], [ -73.89610003199994, 40.74977367200006 ], [ -73.89618582899993, 40.74990139300007 ], [ -73.89654167899994, 40.75055024900007 ], [ -73.89579995399993, 40.750627972000075 ], [ -73.89584983599991, 40.75069971000005 ], [ -73.8961773019999, 40.752467763000084 ], [ -73.89619341999992, 40.75256796500008 ], [ -73.89623743299995, 40.752819539000086 ], [ -73.89626560799991, 40.75298058800007 ], [ -73.8964464419999, 40.75397914600006 ], [ -73.8965235739999, 40.754397048000044 ], [ -73.8964461779999, 40.754405004000034 ], [ -73.8960468599999, 40.75444605000007 ], [ -73.89570034899992, 40.75448166800004 ], [ -73.89559097499995, 40.75449291000007 ], [ -73.89466232699993, 40.75459170600004 ], [ -73.8937357229999, 40.75468902800009 ], [ -73.89280469899995, 40.754786193000086 ], [ -73.89188191999995, 40.75488159200006 ], [ -73.8909489479999, 40.75498201500005 ], [ -73.89001466099995, 40.75507908600008 ], [ -73.88908942299992, 40.75517864500006 ], [ -73.88901097599995, 40.755184660000054 ], [ -73.88815798999991, 40.75527409300008 ], [ -73.88722909499995, 40.75537158000009 ], [ -73.88629940899995, 40.75546874400004 ], [ -73.88536853599993, 40.75556522200009 ], [ -73.88444034399993, 40.755665727000064 ], [ -73.88350818299995, 40.755763597000055 ], [ -73.88258038599992, 40.75586184900004 ], [ -73.88164938499995, 40.75595986900004 ], [ -73.88072054199995, 40.756057368000086 ], [ -73.8799856569999, 40.75613419500007 ], [ -73.87979035599994, 40.75615505500008 ], [ -73.87886178299993, 40.75624974500005 ], [ -73.87793155999992, 40.756347289000075 ], [ -73.87699915299993, 40.75644723800008 ], [ -73.87606912599995, 40.75654450400009 ], [ -73.87514000199991, 40.75664209000007 ], [ -73.87420928699993, 40.756739835000076 ], [ -73.8736584749999, 40.75681176000006 ], [ -73.87311180499995, 40.75685916000003 ], [ -73.87297108999991, 40.75687136100004 ], [ -73.87221981899995, 40.75695150100006 ], [ -73.87217833999995, 40.75673912900004 ], [ -73.8718870809999, 40.755121828000085 ], [ -73.87168118299991, 40.75399542700006 ], [ -73.87168609899993, 40.753969114000085 ], [ -73.87172673099991, 40.75393940500004 ], [ -73.87174981899994, 40.75393381100008 ], [ -73.87186300299993, 40.75391227300008 ], [ -73.8719007979999, 40.75390523800007 ], [ -73.87194007799991, 40.753897762000065 ], [ -73.8720717249999, 40.75387025900005 ], [ -73.8720297449999, 40.75378516600006 ], [ -73.8717991609999, 40.75334438100003 ], [ -73.87178725299992, 40.75332186600008 ], [ -73.87097032999992, 40.751791499000035 ], [ -73.8708455929999, 40.75155690100007 ], [ -73.86983872499991, 40.74987463400004 ], [ -73.8698185479999, 40.74984099900007 ], [ -73.8697428129999, 40.749714802000085 ], [ -73.86968676099991, 40.749620631000084 ], [ -73.86963570099994, 40.74953564500004 ], [ -73.86955861799993, 40.74939955700006 ], [ -73.86947435699994, 40.74925079600007 ], [ -73.86942583199993, 40.74916512200008 ] ] ]
      } ], "11372" ]
    , [ 2, [ null, "40.75004865100004", "-73.71068494899993", null, false, {
        "rings" : [ [ [ -73.71068494899993, 40.75004865100004 ], [ -73.71059080799995, 40.74998105800006 ], [ -73.70997246399992, 40.74958304200004 ], [ -73.70883534899991, 40.74885624600006 ], [ -73.7086951309999, 40.74876662200006 ], [ -73.70856622499991, 40.74883508500005 ], [ -73.70833971499991, 40.748953361000076 ], [ -73.70803740399992, 40.749112042000036 ], [ -73.70792532999991, 40.749173119000034 ], [ -73.70780220699993, 40.74923483200007 ], [ -73.7071659149999, 40.749575941000046 ], [ -73.70713205399994, 40.74959099700004 ], [ -73.70694428799993, 40.74960633000006 ], [ -73.70675731099993, 40.74962159900008 ], [ -73.70603156099992, 40.74978186000004 ], [ -73.7051035959999, 40.749983729000064 ], [ -73.70420088499992, 40.75017781000008 ], [ -73.70397522199994, 40.74956778500007 ], [ -73.70354820499995, 40.748420390000035 ], [ -73.70288531299991, 40.74663844400004 ], [ -73.70218649199995, 40.74475014400008 ], [ -73.70308842299994, 40.74455551300008 ], [ -73.70242552099995, 40.74277132200007 ], [ -73.70239969699992, 40.742701812000064 ], [ -73.70166614899995, 40.74072594000006 ], [ -73.70098398999994, 40.73890395400008 ], [ -73.70191335899995, 40.738719193000065 ], [ -73.70283626499992, 40.73852115300008 ], [ -73.70373752799992, 40.738327336000054 ], [ -73.70464001599993, 40.73813312700008 ], [ -73.70557587799993, 40.73793163800008 ], [ -73.7065152429999, 40.737730196000086 ], [ -73.70741906899991, 40.73753670500008 ], [ -73.70832021699994, 40.73734210500004 ], [ -73.70861677199991, 40.737278626000034 ], [ -73.70922153099991, 40.73714812600008 ], [ -73.71012567899993, 40.73695393600008 ], [ -73.71102804499992, 40.736759290000066 ], [ -73.71193174299992, 40.73656533600007 ], [ -73.71283303599995, 40.736371794000036 ], [ -73.7137115399999, 40.736182959000075 ], [ -73.71389216099993, 40.73649424100006 ], [ -73.71407535799995, 40.73680996200005 ], [ -73.71421188499994, 40.73699833300009 ], [ -73.71436748999992, 40.73725217200007 ], [ -73.7144529489999, 40.73739504400004 ], [ -73.71459247799993, 40.73759072300004 ], [ -73.71474304399993, 40.737837622000086 ], [ -73.71477102099993, 40.73790862300007 ], [ -73.7148030159999, 40.73799590600004 ], [ -73.71487967099995, 40.73814631200008 ], [ -73.71500834099993, 40.738347873000066 ], [ -73.71511241199994, 40.738576686000044 ], [ -73.71513666299995, 40.73865709000006 ], [ -73.71515782499995, 40.738697320000085 ], [ -73.71521606599993, 40.73880792400007 ], [ -73.71534159799995, 40.73898486500008 ], [ -73.71544720299994, 40.73921805100008 ], [ -73.71546813999993, 40.739290521000044 ], [ -73.71547804599993, 40.73930909200004 ], [ -73.7155545299999, 40.739452096000036 ], [ -73.71568016899994, 40.739637404000064 ], [ -73.71578439799993, 40.739902623000035 ], [ -73.71593978199991, 40.740275272000076 ], [ -73.71607328399995, 40.74055399000008 ], [ -73.7163779519999, 40.74120728500009 ], [ -73.71656934299995, 40.74165873900006 ], [ -73.71659261199994, 40.74174090100007 ], [ -73.71670826999991, 40.74200073800006 ], [ -73.71681697399993, 40.742209277000086 ], [ -73.71705451399993, 40.74273874700009 ], [ -73.7171499339999, 40.74294925600009 ], [ -73.71740717999995, 40.74351920700008 ], [ -73.71760949999992, 40.744002210000076 ], [ -73.71762635899995, 40.74403675800005 ], [ -73.7177760379999, 40.74438419200004 ], [ -73.71789847999992, 40.74462682500007 ], [ -73.71819428999993, 40.745285254000066 ], [ -73.7182441679999, 40.74539936100007 ], [ -73.7182768479999, 40.745512794000035 ], [ -73.71833624999994, 40.74564472900005 ], [ -73.71844446099993, 40.74581312400005 ], [ -73.71854684399995, 40.74607995400004 ], [ -73.71867196999995, 40.74632324600009 ], [ -73.71870014399991, 40.74642002600007 ], [ -73.71894422199995, 40.74696462400004 ], [ -73.71908251199994, 40.74736088100008 ], [ -73.71917054699992, 40.747565432000044 ], [ -73.71948888799994, 40.74845834700005 ], [ -73.71966263999991, 40.748953493000045 ], [ -73.71989691999994, 40.749402056000065 ], [ -73.71993402499993, 40.74950141900007 ], [ -73.71998938799993, 40.74960782900007 ], [ -73.72008050599993, 40.749776626000084 ], [ -73.72024347999991, 40.750027283000065 ], [ -73.7203715519999, 40.750274783000066 ], [ -73.72042479499993, 40.75038229900008 ], [ -73.72083010199992, 40.75118128500009 ], [ -73.72084207599994, 40.751215857000034 ], [ -73.72090908399991, 40.751455355000076 ], [ -73.72099693399991, 40.75169124700005 ], [ -73.72106127299992, 40.75190476600005 ], [ -73.72109444799992, 40.75204710100007 ], [ -73.72114736599991, 40.75224749500006 ], [ -73.72117930199994, 40.752330149000045 ], [ -73.72122882999992, 40.752417310000055 ], [ -73.72127253399992, 40.75249329700006 ], [ -73.72161814399993, 40.75278990500004 ], [ -73.7221076379999, 40.75309158200008 ], [ -73.72242551999994, 40.753304041000035 ], [ -73.72250743399991, 40.75336672800006 ], [ -73.7225716829999, 40.753442764000056 ], [ -73.72260665099992, 40.753503107000085 ], [ -73.7227056829999, 40.75374197200006 ], [ -73.72268214199994, 40.753779113000064 ], [ -73.7225335309999, 40.754013591000046 ], [ -73.7222740009999, 40.754316491000054 ], [ -73.72216053599993, 40.754447405000064 ], [ -73.72206166899991, 40.754561478000085 ], [ -73.72194949199991, 40.75471743400004 ], [ -73.72183731399991, 40.75487338900007 ], [ -73.72168652499994, 40.755125175000046 ], [ -73.72160965899991, 40.75525889700003 ], [ -73.72154447499992, 40.755406039000036 ], [ -73.72144388699991, 40.755597730000034 ], [ -73.72136092499994, 40.75578500200004 ], [ -73.72127207499994, 40.75597672300006 ], [ -73.72109410799993, 40.75628960000006 ], [ -73.72038695799995, 40.75607448300008 ], [ -73.71944208899993, 40.75582077000007 ], [ -73.7184455769999, 40.755542277000075 ], [ -73.71800744199993, 40.75541725900007 ], [ -73.71792076299994, 40.75538899400004 ], [ -73.71775462499994, 40.755355817000066 ], [ -73.71765289899992, 40.75539817500004 ], [ -73.71764167099991, 40.75542656400006 ], [ -73.71763454299992, 40.75544037100008 ], [ -73.7176273579999, 40.75545429400006 ], [ -73.71760527099991, 40.75549763600009 ], [ -73.71759618499993, 40.75551269400006 ], [ -73.71756051599993, 40.755556986000045 ], [ -73.71746903999991, 40.75566837100007 ], [ -73.71731078399995, 40.75596608800004 ], [ -73.7153472199999, 40.75551719100008 ], [ -73.71539460799994, 40.75536684200006 ], [ -73.71543856999995, 40.755178587000046 ], [ -73.71546811999991, 40.75512514600007 ], [ -73.7155322399999, 40.755072838000046 ], [ -73.71546655499992, 40.75506281500009 ], [ -73.71545493699995, 40.75505256100007 ], [ -73.7154190249999, 40.75500670200006 ], [ -73.7154223469999, 40.754988016000084 ], [ -73.71541943099993, 40.75495902300008 ], [ -73.71541786499995, 40.754942838000034 ], [ -73.71543151399993, 40.75470964300007 ], [ -73.71542516099993, 40.75450530000006 ], [ -73.71528810799992, 40.75330328800004 ], [ -73.71528305499993, 40.75328511100008 ], [ -73.71527337499992, 40.75323432600004 ], [ -73.71527070399992, 40.75313876200005 ], [ -73.7152678189999, 40.75303559900004 ], [ -73.7152619119999, 40.75302097700006 ], [ -73.71525564299992, 40.75300113600008 ], [ -73.71525038699991, 40.75296694900004 ], [ -73.7151503959999, 40.752065565000066 ], [ -73.71513710199991, 40.75200083900006 ], [ -73.71511105299993, 40.75192386200007 ], [ -73.71510584299995, 40.751902629000085 ], [ -73.71509927099993, 40.751820028000054 ], [ -73.71497162299994, 40.75182435100004 ], [ -73.71493784899991, 40.75179806400007 ], [ -73.71390338299994, 40.751136613000085 ], [ -73.71373250499994, 40.75103687600006 ], [ -73.71263355499991, 40.75031514300008 ], [ -73.71233338999991, 40.75013140500005 ], [ -73.71174936999995, 40.74975323600006 ], [ -73.71149413699993, 40.74958686400004 ], [ -73.7113303189999, 40.74948276500004 ], [ -73.71121787599992, 40.74958617100009 ], [ -73.71068494899993, 40.75004865100004 ] ] ]
      } ], "11004" ] ]
    }
    JSON
  end

  describe "#columns" do
    subject { Socrata::Loader.new(sample_json).columns }

    it "should return column information" do
      subject.map { |column| column["name"] }.should == %w(id Shape ZIP)
    end
  end

  describe "#each" do
    subject { Socrata::Loader.new(sample_json) }

    it "should yeild every row" do
      row = subject.first

      row[0].should == 1
      row[1][1].should == "40.74916512200008"
      row[1][2].should == "-73.86942583199993"
      row[2].should == "11372"
    end
  end
end
